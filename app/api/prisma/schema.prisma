generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  customer
  provider
  admin
}

enum OrderStatus {
  pending
  paid
  cancelled
  fulfilled
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

model User {
  id            String   @id @default(uuid())
  role          Role
  email         String   @unique
  passwordHash  String
  phone         String?
  phoneVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  lastLogin     DateTime?

  profile       UserProfile?
  providerProfile ProviderProfile?
  services      Service[] @relation("CreatorServices")
  orders        Order[]   @relation("UserOrders")
  createdOrders Order[]   @relation("CreatorOrders")
  favorites     Favorite[]
  refreshTokens RefreshToken[]
  visitorLinks  VisitorUserLink[]
  activityLogs  ActivityLog[]
}

model UserProfile {
  userId       String  @id
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName     String?
  gender       String?
  dateOfBirth  DateTime?
  nationality  String?
  primaryCountry String?
  notes        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ProviderProfile {
  userId      String @id
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  bio         String?
  country     String?
  city        String?
  location    String?
  telegramId  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  languages   ProviderLanguage[]
}

model Language {
  id    Int    @id @default(autoincrement())
  name  String @unique
  providers ProviderLanguage[]
}

model ProviderLanguage {
  providerId String
  languageId Int
  provider   ProviderProfile @relation(fields: [providerId], references: [userId], onDelete: Cascade)
  language   Language        @relation(fields: [languageId], references: [id], onDelete: Restrict)

  @@id([providerId, languageId])
}

model Category {
  id    String @id @default(uuid())
  name  String @unique
  services Service[]
}

model Service {
  id             String   @id @default(uuid())
  creatorId      String
  creator        User     @relation("CreatorServices", fields: [creatorId], references: [id], onDelete: Cascade)

  title          String
  description    String
  mainImageUrl   String?
  galleryImages  Json?
  categoryId     String?
  category       Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  basePrice      Decimal  @db.Decimal(12,2)
  durationMinutes Int
  active         Boolean  @default(true)
  featuredRank   Int?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orders         Order[]
  favorites      Favorite[]
}

model Favorite {
  userId    String
  serviceId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([userId, serviceId])
  @@index([serviceId])
}

model Order {
  id         String      @id @default(uuid())
  userId     String
  serviceId  String
  creatorId  String

  user       User        @relation("UserOrders", fields: [userId], references: [id], onDelete: Restrict)
  service    Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  creator    User        @relation("CreatorOrders", fields: [creatorId], references: [id], onDelete: Restrict)

  status     OrderStatus @default(pending)
  totalPrice Decimal     @db.Decimal(12,2)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  payments   Payment[]
  @@index([userId, createdAt])
  @@index([creatorId, createdAt])
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  provider      String
  amount        Decimal       @db.Decimal(12,2)
  status        PaymentStatus @default(pending)
  transactionRef String?
  paidAt        DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
}

model Visitor {
  id         String   @id @default(uuid())
  ipHash     String   @unique
  country    String?
  city       String?
  userAgent  String?
  firstSeen  DateTime @default(now())
  lastSeen   DateTime @default(now())
  totalVisits Int     @default(1)

  links      VisitorUserLink[]
  activityLogs ActivityLog[]
}

model VisitorUserLink {
  visitorId String
  userId    String
  linkedAt  DateTime @default(now())

  visitor   Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([visitorId, userId])
  @@index([userId])
}

model AdvertisingSpace {
  id        String   @id @default(uuid())
  slot      String   @unique
  title     String
  subtitle  String
  image     String
  ctaLabel  String?
  ctaHref   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history   AdvertisingSpaceHistory[]

  @@map("advertising_spaces")
}

model AdvertisingSpaceHistory {
  id        String   @id @default(uuid())
  slot      String
  space     AdvertisingSpace @relation(fields: [slot], references: [slot], onDelete: Cascade)
  title     String
  subtitle  String
  image     String
  ctaLabel  String?
  ctaHref   String?
  action    String   @default("update")
  changedAt DateTime @default(now())

  @@map("advertising_space_history")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  visitorId String?

  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  visitor   Visitor? @relation(fields: [visitorId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([visitorId, createdAt])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String   @unique
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}
